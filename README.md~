# Introduction
This repository contains tools and files for reverse engineering Browning Trail Cameras.  So far, it is focused on the Recon Force Advantage (BTC-7A), Recon Force SpecOps (BTC-8A), and Edge Spec Ops (BTC-8E).

These trail cameras use IP developed under the SunPlus/iCatch consortium, as well as customizations introduced by the camera maker Prometheus Group, LLC

These tools allow:

* the command vocabulary of the serial debug port
* the extraction or "carving" of pieces of firmware components from firmware update (\*.BRN) files available from the vendor
* the extraction of a binary image from the board embedded EEPROM via the serial debug interface on the Camera PCB
* the extraction of a binary image of DRAM via the serial debug interface on the camera PCB
* analysis of these files using Ghidra, as well as the current hand-labeled source code generated by Ghidra
* patching the application binary by hand, by addition of machine code; or via the gcc c-compiler, assembler, linker, and loader
* the creation of new \*.BRN files with new or modified components, including new or modified filesystem images, and new or modified application binary

The tools are written primarily in Python, and have been optimized to run in the Google Colab environment.  Code that cannot run in the cloud, such as the EEPROM extractor, which requires access to a local USB serial port, are written in C and optimized for MS VisualStudio2017.

These tools are provided with no guarantee, and without authorization or support by Prometheus Group, LLC, or the SunPlus/iCatch consortium.  Use at your own risk

# Browning Trail Camera Hardware and Software environment
The Browning Trail camera software environment is targeted at the iCatch V3x MIPS-core-based SOC products.

The Camera Hardware include:
* a single image sensor (e.g. the Sony SonyIMX291)
* a high speed interface to an SD card for storing photos and videos
* a 4-bit wide high speed EEPROM for storing program, filesystem, and configuration data,
* a VGA color LCD screen and push button interface
* a driver for an LED illuminator for night-time photos and videos
* a driver for a motor which moves an IR-filter in or out of the optical path
* a real-time-clock
* a digital interface to an ultra-low-power Passive InfraRed (PIR) sensor for target detection
* a USB port
* an external HDMI port.

TODO -- make a block diagram

The BTC runs the ThreadX RTOS with a local SunPlus/iCatch shim code.

Most of the time, the BTC hardware is in an extremely low-power state to conserve battery energy.  In this state, the DRAM, MIPS processor, and image processing pipeline are all powered off.  The only active elements are:
* the RTC
* an interrupt system which monitors two inputs -- one from the PIR sensor (indicating that an animal has been detected), and one from the keyboard and soft "on switch".

When a "power on" or "PIR interrupt" is detected, the camera wakes to an active state in which other subsystems are powered-on.  Critically, before executing any code, the SOC loads DRAM with the combined appliation and RTOS binary from a region in the EEPROM.  Once the RTOS is up, the application has access to a file system comprising EEPROM-based  "A:" and "B:" drives, as well as the SD card "D:" drive.  

The EEPROM drives store read-only files (e.g. those that configure the image processing pipeline and JPG and SFN files for the cameras UI), as well as read-write files for storing configuration state (e.g. the user settings).

The BTC firmware makes extensive use of internal timers, which tend to put the camera into it's low power, "waiting to take a photo or video" mode.  These timers are generally active, but are disabled when the device is in "USB-external-device" mode, and when the user is reviewing photos and videos on the LCD screen.

As far as I can tell, the native source code is C (vs. C++), with extensive use of global variables to store shared data structures.

# Debug Serial port
The BTC-7A, 8A, 7E, 8E all support a debug serial interface.  Pads on the PCB labeled, "GND", "RX", "TX", and "VCC" comprise a 3.3 Volt serial interfaces configured for 115,200 Baud.

The command line interface is not available in all modes.  In addition, it may be subject to the watchdog timer, as shown in table belw

| Operating Mode | Command Line Supported | Watchdog Timer will Reset |
| -------------- | ---------------------- | ------------------------- |
| Configuration  | Yes  | Yes |
| Taking Photos/Videos | No | NA |
| USB Slave | Yes | No

The command line interface supports the following commands.  "Help" column are results of typing "command -help".  Notes provide additional information. Unfortunately, most commands do not contain a "help" string.

| Command | Help | Notes |
| ------- | ---- | ----- |
| 360rst | |
| ad | |
| addrdump	| |
| aeset	| |
| bayeroff |	|
| cd	| change directory | Note avaialble file systems are A:\\, B:\\, and D:\\
| cdspdump	| |
| cdspinfo	| |
| cdspload	| |
| cdsplut	 | |
| cdspreg	| |
| chkdsk	| chkdsk - To Check the FAT link of file or disk. Ex. chdkdsk SUNP0001.JPG |
| clocktree	| clocktree - To disply the system clock tree setting. | |
| copy	file copy <src<> <destination>
| cq0	| |
| del	| |
| diq	| |
dir
dispclk
dispcmen
dispcmset
dly	dly - To delay by use GEN GPIO 0.;  dly < unit > < value >;      Unit : 0 : 100ns, 1: 1ms;        Value: Delay count by unit
dram	      
dramdmachk	  
dump	dump - Dump memory, dump [<b/w/h/l>] [<saddr> [<[+]eaddr>]], and use '0x' for
	       hex  The end address (eaddr) can be a value or have a '+' to indicate
	       a length.
edgechk
emmcBreach
emmce
emmcFwDump
emmcInfo
emmcinit
emmcIsp
emmcr
emmcscan
emmcSysChk
emmcw
fcrc
fct
fhelp
fill	fill - Fill memory, fill [<b/w/h/l>] <saddr> <[+]eaddr> <data>, use '0x' for
	       hex.
fmt	fmt - Format drive to special type of filesystem.
	      usage: fmt <drive> <0|1> <FAT|FAT12|FAT16|FAT32|exFAT>
	      Ex. fmt D: 0 FAT16
fpg
fpllset
frmrate
frpsz
fsif
gpiomuxset
gpioswapset
help
htmrd	htmrd - To display the status of host timer.
	         htmrd < tmrId >
	         tmrId : 0 ~ 7, if 0xffff will show all





htmre	htmre - To enable/disable the host timer.
	         htmre < tmrId > < enable >
	         tmrId : 0 ~ 7 ( 0xffff will apply to all timer )
	         enable: 0/1 --> disable/enable.
htmrs	htmrs - To config the host timer.
	         htmrs < tmrId > < unit >
	         tmrId : 0 ~ 7
	         unit : Example 10 = 10ms.
hwver
info	info - Display drive information. info <drive name>
io
iocfg
iodir
ioext
iq
iqsave
ldsysinfo
ldtbltest
ls	list file contents
mapExe
mapVar
media	media - sub commands: play ff abort thumb seek
mkdir	h
msg	msg - To send message
h	       msg < cmd > < para >
obdetonly
os	os - Print OS information. Type os ? for more information
proc	proc - proc en ms
prof	profile -- debug printf statements from at uS granulrity
pwm
pwmcfg
r
rcablc
rcamw
rcaraw
rcasms
read	read - Read file to DRAM. Ex. read TEST.BIN 0xa1000000
regdump
ren	rename file
reportsize	reports sensor frame size options
reporty
rmdir
rr
rsver	rsver - Erase rserved block (logical indexed) of SPI. rsvrd <blk>
rsvrd	rsvrd - Read rserved block of SPI. rsvrd <page> <nrPages> <address of DRAM>
rsvsdrd	rsvrd - Read rserved block of SPI. rsvrd <page> <nrPages> <address of DRAM>
rsvsdwr	rsvsdwr - Write rserved block of SD. rsvwr <page> <nrPages> <address of DRAM>
rsvwr	rsvwr - Write rserved block of SPI. rsvwr <page> <nrPages> <address of DRAM>
rtcg	rtcg - To display RTC time ...
	        rtcs < option >
	        option = 0 --> data/time
	        option = 1 --> alarm data/time
	      To display RTC reliable code ...
	        rtcs < option >
	        option = 2
rtcreg	rtcreg - rtcreg : dump all RTC reg
	        rtcreg <addr> : read specified RTC reg
	        rtcreg <addr> <data> : write specified RTC reg
rtcs	rtcs - To set RTC time ...
	        rtcs < option > < Year > < Mon > < Day > < Hour > < Min > < Sec >
	        option = 0 --> data/time
	        option = 1 --> alarm data/time
	      To set RTC reliable code ...
	        rtcs < option > < code >
	        option = 2
rtct	rtct - To execute the RTC test routine.
	        rtct < Year > < Mon > < Day > < Hour > < Min > < Sec >
sar
save
savepv
saveraw
sdadj	sdadj - Set SD Phase (-8~7) Latch (-8~7)
sdautoscan	sdautoscan - sd parameter scan function
	            sdcan Freq Drive Phase
	            Freq  : 24M, 48M, 96M
	            Drive : H, L
	            Phase : 0x0 ~ 0xf
	            DLdly : 0x0 ~ 0x7
sdboot	sdboot - SD FW boot to an address ( embeded=0,exter=1 )
	        sdboot 0 0xa0000000
sdcfg	sdcfg - To cfg sd/mmc card.
	         sdcfg < sd/mmc > < bus> < freq >
	         sd/mmc : sd = 0, mmc = 1
	         bus    : 1 bit[0], 4 bit[1], 8 bit[2]
	         freq   : 24M[0], 12M[1], 6M[2], 375K[3], 48M[4]
sdcheck
sdclk	sdclk - Set SD Clock (MHz)
sdcsdr	sdcsdr - SD device read/write test
	        sdrwt num blk
sdcsdw	sdcsdw - SD device read/write test
	        sdrwt num blk
sddrv	sddrv - Set SD driving (0~3:2~8mA)
sdfwr	sdfwr - Read F/W from SD's reserved blocks. rsvfwr <addr> <size>
sdfww	sdfww - Write F/W into SD's reserved blocks. rsvfww <addr> <size>
sdhdr	sdhdr - Display SD's reserved header.
	       rsvhdr
sdlock
sdr	sdr - Read a physical page from SD card. sdpr <devId> <page> <address of DRAM>
sdrwt	sdrwt - SD device read/write test
	       sdrwt num blk
sdscan	sdscan - sd parameter scan function
	        sdcan Freq Drive Phase
	        Freq  : 24M, 48M, 96M
	        Drive : H, L
	        Phase : 0x0 ~ 0xf
	        DLdly : 0x0 ~ 0x7
sdset	sdset - Allocate SD's reserved blocks.
	       rsvset < size A > < size B > < size C > ( bytes )
sdSpeedSet
sdtest	sector by sector check of SD card -- takes a (really) long time :(
sdtune
sdtx	sdtx - To send command to sd/mmc card.
	        sdtx < cmd > < arg > < rsp > < buf >
sdw	sdw - Write a physical page from SD card. sdpr <devId> <page> <address of
	      DRAM>
search	search - Search memory, search [<b/w/h/l>] <saddr> [<[+]eaddr>] <pattern>,
	         and use '0x' for hex.
sizedump	interesting status
sleep2
snap
spibus	spibus - set SPI bit width. spibus <bit width 1,2,4>
spidet	spidet - SPI device detect
	        spidet
spidrv	spidrv - set SPI driving strengh. spidrv <0~3>
spier	spier - Erase one block, spier <devId> <page>
spifwr	spifwr - Read F/W from SPI's reserved blocks. rsvfwr <addr> <size>
spifww	spifww - Write F/W into SPI's reserved blocks. rsvfww <addr> <size>
spihdr	spihdr - Display SPI's reserved header.
	        rsvhdr
spipr	spipr - Read a physical page from SPI card. spipr <devId> <page> <address of
	        DRAM>
spipw	spipw - Write a physical page from SPI card. spipr <devId> <page> <address of
	        DRAM>
spir	spir - Read a physical page from SPI card. spipr <devId> <page> <address of
	       DRAM>
spirwt	spirwt - SPI device read/write test
	        spirwt num blk
spiscan	spiscan - spi scan function
	         mode  : 0,3,4
	         drv   : 0~3
	         bus   : 1,2,4
	         clk   : 1~254
	         div   : 0~7
spiset	spiset - Allocate SPI's reserved blocks.
	        rsvset < size A > < size B > < size C > ( bytes )
suspend
syspllset
Test_eMMCIRW
Test_SDIRW
Test_SPIRW
usb
usbls
usbmm
usbms
usbsc
usbt
ver

verify	verify - verify #file [#repeat #len].  Read file several time and verify
videostate
w
write	write - Write file to card. Ex. write TEST.BIN 0xa1000000 1024
wrloop	wrloop - Write files and delete files when disk full



# Carving the a Browning .BRN file

# Extracting EEPROM image

# Extracting DRAM image

# Ghidra

# Patcher

# BRN file Creator

# References

* [iCatch V35 Prduct Overview](https://www.icatchtek.com/ProductContent/1e74aa9e8e3c4bdcbfc5ee0f9c1a8206)
