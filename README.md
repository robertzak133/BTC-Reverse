# Introduction
This repository contains tools and files for reverse engineering Browning Trail Cameras.  So far, it is focused on the Recon Force Advantage (BTC-7A), Recon Force SpecOps (BTC-8A), and Edge Spec Ops (BTC-8E).

These trail cameras use IP developed under the SunPlus/iCatch consortium, as well as customizations introduced by the camera maker Prometheus Group, LLC

These tools allow:

* the command vocabulary of the serial debug port
* the extraction or "carving" of pieces of firmware components from firmware update (\*.BRN) files available from the vendor
* the extraction of a binary image from the board embedded EEPROM via the serial debug interface on the Camera PCB
* the extraction of a binary image of DRAM via the serial debug interface on the camera PCB
* analysis of these files using Ghidra, as well as the current hand-labeled source code generated by Ghidra
* patching the application binary by hand, by addition of machine code; or via the gcc c-compiler, assembler, linker, and loader
* the creation of new \*.BRN files with new or modified components, including new or modified filesystem images, and new or modified application binary

The tools are written primarily in Python, and have been optimized to run in the Google Colab environment.  Code that cannot run in the cloud, such as the EEPROM extractor, which requires access to a local USB serial port, are written in C and optimized for MS VisualStudio2017.

These tools are provided with no guarantee, and without authorization or support by Prometheus Group, LLC, or the SunPlus/iCatch consortium.  Use at your own risk

# Browning Trail Camera Hardware and Software environment
The Browning Trail camera software environment is targeted at the iCatch V3x MIPS-core-based SOC products.

The Camera Hardware include:
* a single image sensor (e.g. the Sony SonyIMX291)
* a high speed interface to an SD card for storing photos and videos
* a 4-bit wide high speed EEPROM for storing program, filesystem, and configuration data,
* a VGA color LCD screen and push button interface
* a driver for an LED illuminator for night-time photos and videos
* a driver for a motor which moves an IR-filter in or out of the optical path
* a real-time-clock
* a digital interface to an ultra-low-power Passive InfraRed (PIR) sensor for target detection
* a USB port
* an external HDMI port.

TODO -- make a block diagram

The BTC runs the ThreadX RTOS with a local SunPlus/iCatch shim code.

Most of the time, the BTC hardware is in an extremely low-power state to conserve battery energy.  In this state, the DRAM, MIPS processor, and image processing pipeline are all powered off.  The only active elements are:
* the RTC
* an interrupt system which monitors two inputs -- one from the PIR sensor (indicating that an animal has been detected), and one from the keyboard and soft "on switch".

When a "power on" or "PIR interrupt" is detected, the camera wakes to an active state in which other subsystems are powered-on.  Critically, before executing any code, the SOC loads DRAM with the combined appliation and RTOS binary from a region in the EEPROM.  Once the RTOS is up, the application has access to a file system comprising EEPROM-based  "A:" and "B:" drives, as well as the SD card "D:" drive.  

The EEPROM drives store read-only files (e.g. those that configure the image processing pipeline and JPG and SFN files for the cameras UI), as well as read-write files for storing configuration state (e.g. the user settings).

The BTC firmware makes extensive use of internal timers, which tend to put the camera into it's low power, "waiting to take a photo or video" mode.  These timers are generally active, but are disabled when the device is in "USB-external-device" mode, and when the user is reviewing photos and videos on the LCD screen.

As far as I can tell, the native source code is C (vs. C++), with extensive use of global variables to store shared data structures.

# Debug Serial port
The BTC-7A, 8A, 7E, 8E all support a debug serial interface.  Pads on the PCB labeled, "GND", "RX", "TX", and "VCC" comprise a 3.3 Volt serial interfaces configured for 115,200 Baud.

The command line interface is not available in all modes.  In addition, it may be subject to the watchdog timer, as shown in table below

| Operating Mode | Command Line Supported | Watchdog Timer will Reset | SD (D:) Available |
| -------------- | ---------------------- | ------------------------- | ----------------- |
| Configuration  | Yes  | Yes | Yes |
| Playback       | Yes  | No |  Yes |
| Taking Photos/Videos | No | NA | No |
| USB Slave | Yes | No | No |

The command line interface supports the following commands.  "Help" column are results of typing "command -help".  Notes provide additional information. Unfortunately, most commands do not contain a "help" string.

| Command | Help | Notes |
| ------- | ---- | ----- |
| 360rst  |      |       |
| ad | | |
| addrdump | | |
| aeset	| | |
| bayeroff | | |
| cd	| change directory | Note avaialble file systems are A:\\, B:\\, and D:\\ |
| cdspdump	| | |
| cdspinfo	| | |
| cdspload	| | |
| cdsplut	| | |
| cdspreg	| | |
| chkdsk	| chkdsk - To Check the FAT link of file or disk. Ex. chdkdsk SUNP0001.JPG | |
| clocktree	| clocktree - To disply the system clock tree setting. | | |
| copy	        | file copy <src<> <destination> | |
| cq0	| | |
| del	| | |
| diq	| | |
| dir   | | print the contents of current directory (equivalent to "ls") |
| dispclk | | |
| dispcmen | | |
| dispcmset | | |
| dly	| dly - To delay by use GEN GPIO 0.;  dly < unit > < value >; Unit : 0 : 100ns, 1: 1ms; Value: Delay count by unit | |
| dram | | |  
| dramdmachk | | |
| dump	| dump - Dump memory, dump [<b/w/h/l>] [<saddr> [<[+]eaddr>]], and use '0x' for hex;  The end address (eaddr) can be a value or have a '+' to indicate a length. | Dumps to serial output |
| edgechk | | |
| emmcBreach | | emmc does not seem be supported in the BTC hardware |
| emmce | | emmc does not seem be supported in the BTC hardware |
| emmcFwDump | | emmc does not seem be supported in the BTC hardware |
| emmcInfo | | emmc does not seem be supported in the BTC hardware |
| emmcinit | | emmc does not seem be supported in the BTC hardware |
| emmcIsp | | emmc does not seem be supported in the BTC hardware |
| emmcr | | emmc does not seem be supported in the BTC hardware |
| emmcscan | | emmc does not seem be supported in the BTC hardware |
| emmcSysChk | | emmc does not seem be supported in the BTC hardware |
| emmcw | | emmc does not seem be supported in the BTC hardware |
| fcrc  | | |  
| fct  | | |  
| fhelp  | | |  
| fill | fill - Fill memory, fill [<b/w/h/l>] <saddr> <[+]eaddr> <data>, use '0x' for hex| |
| fmt | fmt - Format drive to special type of filesystem. usage: fmt <drive> <0|1> <FAT|FAT12|FAT16|FAT32|exFAT>; Ex. fmt D: 0 FAT16 | |
| fpg | | |
| fpllset | | |
| frmrate | | |
| frpsz | | |
| fsif | | |
| gpiomuxset | | |
| gpioswapset | | |
| help | | |
| htmrd	| htmrd - To display the status of host timer. htmrd < tmrId >; tmrId : 0 \~ 7, if 0xffff will show all | |
| htmre	htmre - To enable/disable the host timer; htmre < tmrId > < enable >; tmrId : 0 \~ 7 ( 0xffff will apply to all timer ); enable: 0/1 --> disable/enable. | does not disable watchdog timer |
| htmrs	| htmrs - To config the host timer; htmrs < tmrId > < unit >; tmrId : 0 \~ 7; unit : Example 10 = 10ms. | |
| hwver | | Print Hardware version to serial port |
| info	| info - Display drive information. info <drive name> | |
| io  | | |
| iocfg | | |
| iodir | | |
| ioext | | |
| iq | | |
| iqsave | | |
| ldsysinfo | | |
| ldtbltest | | |
| ls | list file contents | list file contents of current directory; same as "dir" |
| mapExe | | |
| mapVar | | |
| media	| media - sub commands: play ff abort thumb seek |  |
| mkdir	| | make directory |
| msg   | msg - To send message msg < cmd > < para > | |
| obdetonly | | |
| os | os - Print OS information. Type os ? for more information | |
| proc	| proc - proc en ms | |
| prof	| profile -- debug printf statements from at uS granularity | |
| pwm   | | |
| pwmcfg | | |
| r      | | read from memory r [<b/w/h/l>] <saddr> <[+]eaddr> <data>, use '0x' for hex| |
| rcablc | | |
| rcamw | | |
| rcaraw | | |
| rcasms | | |
| read	| read - Read file to DRAM. Ex. read TEST.BIN 0xa1000000 | Used to dump program contents to file on SD card as binary |
| regdump | | |
| ren |	rename file | |
| reportsize | reports sensor frame size options | |
| reporty | | |
| rmdir | | remove named direcotry |
| rr  | | |
| rsver | rsver - Erase rserved block (logical indexed) of SPI. rsvrd <blk> | |
| rsvrd | rsvrd - Read rserved block of SPI. rsvrd <page> <nrPages> <address of DRAM> | |
| rsvsdrd | rsvrd - Read rserved block of SPI. rsvrd <page> <nrPages> <address of DRAM> | |
| rsvsdwr |rsvsdwr - Write rserved block of SD. rsvwr <page> <nrPages> <address of DRAM> | |
| rsvwr | rsvwr - Write rserved block of SPI. rsvwr <page> <nrPages> <address of DRAM> | |
| rtcg | rtcg - To display RTC time;  rtcs < option >; option = 0 --> data/time; option = 1 --> alarm data/time;  To display RTC reliable code ...; rtcs < option >; option = 2 | |
| rtcreg | rtcreg - rtcreg : dump all RTC reg; rtcreg <addr> : read specified RTC reg; rtcreg <addr> <data> : write specified RTC reg | |
| rtcs | rtcs - To set RTC time ...; rtcs < option > < Year > < Mon > < Day > < Hour > < Min > < Sec >; option = 0 --> data/time ; option = 1 --> alarm data/time;  To set RTC reliable code ...; rtcs < option > < code >; option = 2 | |
| rtct	| rtct - To execute the RTC test routine; rtct < Year > < Mon > < Day > < Hour > < Min > < Sec > | |
| sar | | |
| save | | |
| savepv | | |
| saveraw | | |
| sdadj	| sdadj - Set SD Phase (-8\~7) Latch (-8\~7) | |
| sdautoscan	| sdautoscan - sd parameter scan function; sdcan Freq Drive Phase; Freq  : 24M, 48M, 96M; Drive : H, L; Phase : 0x0 \~ 0xf; DLdly : 0x0 \~ 0x7 | |
| sdboot | sdboot - SD FW boot to an address ( embeded=0,exter=1 );  sdboot 0 0xa0000000 | |
| sdcfg	| sdcfg - To cfg sd/mmc card; sdcfg < sd/mmc > < bus> < freq >; sd/mmc : sd = 0, mmc = 1; bus    : 1 bit[0], 4 bit[1], 8 bit[2]; freq   : 24M[0], 12M[1], 6M[2], 375K[3], 48M[4] | |
| sdcheck | | |
| sdclk	sdclk | Set SD Clock (MHz) | |
| sdcsdr | sdcsdr - SD device read/write test; sdrwt num blk | |
| sdcsdw | sdcsdw - SD device read/write test; sdrwt num blk | |
| sddrv	| sddrv - Set SD driving (0\~3 mA:2\~8mA) | |
| sdfwr	| sdfwr - Read F/W from SD's reserved blocks. rsvfwr <addr> <size> | |
| sdfww	| sdfww - Write F/W into SD's reserved blocks. rsvfww <addr> <size> | |
| sdhdr	| sdhdr - Display SD's reserved header; rsvhdr | |
| sdlock | | |
| sdr | sdr - Read a physical page from SD card. sdpr <devId> <page> <address of DRAM> | |
| sdrwt	| sdrwt - SD device read/write test; sdrwt num blk |
| sdscan | sdscan - sd parameter scan function; sdcan Freq Drive Phase; Freq  : 24M, 48M, 96M; Drive : H, L; Phase : 0x0 \~ 0xf; DLdly : 0x0 \~ 0x7 | |
| sdset	| sdset - Allocate SD's reserved blocks; rsvset < size A > < size B > < size C > ( bytes ) | |
| sdSpeedSet | | |
| sdtest | sector by sector check of SD card | takes a (really) long time |
| sdtune | | |
| sdtx | sdtx - To send command to sd/mmc card; sdtx < cmd > < arg > < rsp > < buf > | |
| sdw | sdw - Write a physical page from SD card. sdpr <devId> <page> <address of DRAM> | |
| search | search - Search memory, search [<b/w/h/l>] <saddr> [<[+]eaddr>] <pattern>, and use '0x' for hex. | |
| sizedum | | interesting status |
| sleep2 | | |
| snap | | |
| spibus  | spibus - set SPI bit width. spibus <bit width 1,2,4> | |
| spidet  | spidet - SPI device detect; spidet | |
| spidrv  | spidrv - set SPI driving strengh. spidrv <0\~3> | note that this apparently cannot be used to allow "on board" access to the SPI EEPROM |
| spier	| spier - Erase one block, spier <devId> <page> | |
| spifwr | spifwr - Read F/W from SPI's reserved blocks. rsvfwr <addr> <size> | |
| spifww | spifww - Write F/W into SPI's reserved blocks. rsvfww <addr> <size> | |
| spihdr | spihdr - Display SPI's reserved header; rsvhdr | |
| spipr	| spipr - Read a physical page from SPI card. spipr <devId> <page> <address of DRAM> | |
| spipw	| spipw - Write a physical page from SPI card. spipr <devId> <page> <address of DRAM> | |
| spir | spir - Read a physical page from SPI card. spipr <devId> <page> <address of DRAM> | |
| spirwt | spirwt - SPI device read/write test; spirwt num blk | Note that this test is *destrucitve, and will erase the SPI EEPROM, effectively "bricking" the camera |
| spiscan | spiscan - spi scan function; mode  : 0,3,4; drv   : 0\~3; bus   : 1,2,4; clk   : 1\~254; div   : 0\~7 | |
| spiset | spiset - Allocate SPI's reserved blocks. rsvset < size A > < size B > < size C > ( bytes ) | |
| suspend | | |
| syspllset | | |
| Test_eMMCIRW | | |
| Test_SDIRW | | |
| Test_SPIRW | | |
| usb | | |
| usbls | | |
| usbmm | | |
| usbms | | |
| usbsc | | |
| usbt | | |
| ver | | |
| verify | verify - verify #file [#repeat #len].  Read file several time and verify | |
| videostate | | |
| w | | |
| write	 | write - Write file to card. Ex. write TEST.BIN 0xa1000000 1024 | | 
| wrloop | wrloop - Write files and delete files when disk full | |


# Carving the a Browning .BRN file

See [Linouth/iCatch-V50-Playground](https://github.com/Linouth/iCatch-V50-Playground).  The BTC .BRN firmware file consists of the followign elements:

* BRN Header
* Offset1: There is binary code here in Browning firmware iamges, including an application and the RTOS, but I can find no evidence that this program is ever used, or that it is stored in the EERPOM.  Since it is not stored in EEPROM, it cannot be used by the camera, which relies on EEPROM to survive regular low power modes. 

* Offset 2 Header: Header describing the number and extent of file systems
** Offset 2.A : "A:\" File system
** Offset 2.B: "B:\" File system
* Offset 3: Main application and RTOS
* Offset 4:
* Offset 5:
* Offset 6:
* Magic String: "PROMETHEUS" -- note this is outside of the length of the file set in the BRN Header.  The presence of this string at the end of the file is one of the consistency checks the camera firmware peforms before it will load a new .BRN file.

# Extracting EEPROM image

TODO -- find file location -- contains a C-program for Windows (Visual Studio 2017) which extracts the contents of the EEPROM from the debug serial port and stores them as a binary (or .hex) format file.  

TODO -- put in command line arguments for output filename.  If .bin -- use binary format; if .hex; use hex format, else complain

This takes a while at 115200 Baud. 

# Extracting DRAM image

The DRAM on the BTC-{7A, 8A} starts at 0x80000000 and extends to 0x80FFFFFF (16 MBytes).  DRAM contains the RTOS and Application, stack, global vairables, and buffers used for profile database.  The contents of DRAM is lost every time the camera goes into low power state waiting for a trigger and is loaded from EEPROM everty time camera wakes up and takes a picture.  The time to laod DRAM from the EEPROM (approximately 350 ms) is the most significant source of "trigger delay" for the camera.

The contents of DRAM can be transferred to a binary format file on the SD card (D:\ file system) by using the following command from the debug serial port:

cmd> cd 
cmd> write D:\btc-7a-memory-image.bin 0x80000000 8000000

(execute this command while the camera is in "playback mode" to avoid interence of timeouts)


# Ghidra

# Manual Patch Creation

# Source Code Inseration

For more complex pathces, it is desirable to write the patch (a new, or existing function) in C and integrate it into the existing binary.

Find a place for the patch: There are few areas in the binary which are left "free" of code in which to insert a patch of any signficiant new code.  The most effective method I have found for creating this space is to rewrite a function which is oversized because it supports more options than the trail camear hardare supports. 

Example:  setDigitalEffect -- supports 16 different digital effects, only two of which are used by the trail camera.  The existing function, spanning some 3KBytes, can be greatly reduced in size by referencing the only two modes -- default and black and white -- supported by the camera.  The newly created space (\~ 2000 Bytes) can be used for a new function.  

Use Ghidra to resolve necessary external memory and fucntion addresses.  Write these into the linker sript file. 

Compose the patch in C, declaring external memory and function references


# Patcher

Python code which take a manual patch, or a patch generated by C-code path (above) and writes it into a iven application binary image, overwriting the previous contents. 


# BRN file Creator

Takes copies of 
* BRN Header
* Offset1: There is binary code here in Browning firmware iamges, including an application and the RTOS, but I can find no evidence that this program is ever used, or that it is stored in the EERPOM.  Since it is not stored in EEPROM, it cannot be used by the camera, which relies on EEPROM to survive regular low power modes. 

** Offset 2.A : "A:\" File system
** Offset 2.B: "B:\" File system
* Offset 3: Main application and RTOS
* Offset 4:
* Offset 5:
* Offset 6:
* Magic String: "PROMETHEUS" -- note this is outside of the length of the file set in the BRN Header.  The presence of this string at the end of the file is one of the consistency checks the camera firmware peforms before it will load a new .BRN file.

Creates a consisten


Offset2.A, offset 2.B, Offset 3 and creates:

* BRN Header
* Offset 2 Header (based on the file system sizes in Offet2.A and Offset 2.B files)

Then assembles all of these file into the specified output .BRN file.  This file can then be transferred to an SD card and loaded into the BTC via the "Update Firmware" option. 

# Example 1: Hand patch to remove "black and white" from setDigitalEffect function

# Exampel 2: Compiled C-code patch: reduce size of "setDigitalEffect" function and use the available space for a new function that extends the string printed at the bottom of the screen during Playback.

# References

* [Converting a Trail Camera from IR to White Flash] (https://ouroneacrefarm.com/winterberry-wildlife/) Blog post showing use of these tools to modify software in support of converting the BTC-7A from IR to White flash. 

* [Linouth/iCatch-V50-Playground](https://github.com/Linouth/iCatch-V50-Playground): reverse engineering site aimed at reversing action cameras, also based on iCatch/SunPlus IP.  Structure of .BRN file is identifcal, but relatively simpler, since BTC does not compress any of the files in the file-system. 

* [iCatch V35 Prduct Overview](https://www.icatchtek.com/ProductContent/1e74aa9e8e3c4bdcbfc5ee0f9c1a8206)
